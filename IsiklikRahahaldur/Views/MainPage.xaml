<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:IsiklikRahahaldur.ViewModels"
             xmlns:microcharts="clr-namespace:Microcharts.Maui;assembly=Microcharts.Maui"
             x:Class="IsiklikRahahaldur.Views.MainPage"
             Title="{Binding Title}">

    <!-- 
    1. Добавили xmlns:microcharts
    2. Изменили сетку (Grid) - теперь 5 рядов
    3. Добавили ChartView в Grid.Row="2"
    4. Сдвинули CollectionView в Grid.Row="3"
    -->

    <Grid RowDefinitions="Auto, Auto, Auto, *, Auto" Padding="20" RowSpacing="15">

        <!-- Заголовок -->
        <Label Grid.Row="0" Text="Мой кошелек" FontSize="32" FontAttributes="Bold" HorizontalOptions="Center" />

        <!-- Отображение баланса -->
        <Border Grid.Row="1" StrokeShape="RoundRectangle 15" Padding="20" Stroke="LightGray">
            <VerticalStackLayout>
                <Label Text="Текущий баланс" FontSize="16" TextColor="Gray"/>
                <Label Text="{Binding Balance, StringFormat='{0:F2} €'}" FontSize="28" FontAttributes="Bold" HorizontalOptions="Center" />
            </VerticalStackLayout>
        </Border>

        <!-- НОВЫЙ БЛОК: ГРАФИК РАСХОДОВ -->
        <microcharts:ChartView Grid.Row="2"
                               Chart="{Binding ExpensesChart}"
                               HeightRequest="150" />

        <!-- Список транзакций (теперь в Grid.Row="3") -->
        <CollectionView Grid.Row="3" ItemsSource="{Binding Transactions}" Margin="0,10,0,0">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:TransactionDisplayViewModel">
                    <SwipeView>
                        <SwipeView.LeftItems>
                            <SwipeItems Mode="Execute">
                                <SwipeItem Text="Изменить"
                                           BackgroundColor="LightSkyBlue"
                                           Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=GoToEditTransactionCommand}"
                                           CommandParameter="{Binding .}"/>
                            </SwipeItems>
                        </SwipeView.LeftItems>

                        <SwipeView.RightItems>
                            <SwipeItems Mode="Execute">
                                <SwipeItem Text="Удалить"
                                           BackgroundColor="IndianRed"
                                           Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=DeleteTransactionCommand}"
                                           CommandParameter="{Binding .}"/>
                            </SwipeItems>
                        </SwipeView.RightItems>

                        <Border Padding="10" Margin="0,5" StrokeShape="RoundRectangle 10" Stroke="Gainsboro">
                            <Grid ColumnDefinitions="*, Auto">
                                <VerticalStackLayout Grid.Column="0">
                                    <Label Text="{Binding Transaction.Description}" FontAttributes="Bold" />
                                    <Label Text="{Binding CategoryName}" FontSize="12" TextColor="Gray" />
                                    <Label Text="{Binding Transaction.Date, StringFormat='{0:dd.MM.yyyy}'}" FontSize="12" TextColor="LightSlateGray" />
                                </VerticalStackLayout>
                                <Label Grid.Column="1" VerticalOptions="Center" FontAttributes="Bold"
                                       TextColor="{Binding Transaction.IsIncome, Converter={StaticResource BoolToColorConverter}}">
                                    <Label.Text>
                                        <MultiBinding StringFormat="{}{0}{1:F2} €">
                                            <Binding Path="Transaction.IsIncome" Converter="{StaticResource BoolToSignConverter}" />
                                            <Binding Path="Transaction.Amount" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                            </Grid>
                        </Border>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Кнопки действий (теперь в Grid.Row="4") -->
        <Grid Grid.Row="4" ColumnDefinitions="*,*" ColumnSpacing="10">
            <Button Grid.Column="0" Text="+ Доход" Command="{Binding GoToAddTransactionCommand}" BackgroundColor="MediumSeaGreen" TextColor="White" CornerRadius="10">
                <Button.CommandParameter>
                    <x:Boolean>True</x:Boolean>
                </Button.CommandParameter>
            </Button>
            <Button Grid.Column="1" Text="- Расход" Command="{Binding GoToAddTransactionCommand}" BackgroundColor="IndianRed" TextColor="White" CornerRadius="10">
                <Button.CommandParameter>
                    <x:Boolean>False</x:Boolean>
                </Button.CommandParameter>
            </Button>
        </Grid>
    </Grid>

</ContentPage>

